<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>External pointer-based tokens objects • quanteda</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/readable/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../../bootstrap-toc.css">
<script src="../../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../../pkgdown.css" rel="stylesheet">
<script src="../../pkgdown.js"></script><!-- docsearch --><script src="../../docsearch.js"></script><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.3/docsearch.min.css" integrity="sha256-QOSRU/ra9ActyXkIBbiIB144aDBdtvXBcNc3OTNuX/Q=" crossorigin="anonymous">
<link href="../../docsearch.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script><link href="../../extra.css" rel="stylesheet">
<script src="../../extra.js"></script><meta property="og:title" content="External pointer-based tokens objects">
<meta property="og:description" content="quanteda">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=G-0F398Z98L1"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-0F398Z98L1');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../../index.html">quanteda</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">4.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Quick Start
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/quickstart.html">Quick Start Guide</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/quickstart_es.html">Guía de Inicio Rápido</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/quickstart_cn.html">快速入门指南</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/quickstart_ja.html">クイック・スタートガイド</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/quickstart_hi.html">त्वरित आरंभ </a>
    </li>
  </ul>
</li>
<li>
  <a href="../../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Features
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/pkgdown/tokens_xptr.html">External pointer tokens objects</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/benchmarks_xptr.html">Performance benchmarks for v4</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/design.html">Package design</a>
    </li>
    <li>
      <a href="../../news/index.html">Changelog</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Examples
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/pkgdown/examples/phrase.html">Multi-word expressions</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/examples/plotting.html">Textual data visualization</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/examples/lsa.html">Latent Semantic Analysis (LSA)</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/examples/chinese.html">Chinese text analysis</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/examples/twitter.html">Social media analysis</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Replications
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../../articles/pkgdown/replication/digital-humanities.html">Text Analysis with R for Students of Literature</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/replication/text2vec.html">Word embedding (word2vec)</a>
    </li>
    <li>
      <a href="../../articles/pkgdown/replication/qss.html">Quantitative Social Science Ch. 5.1</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/quanteda/quanteda" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
<form class="navbar-form navbar-right hidden-xs hidden-sm" role="search">
        <div class="form-group">
          <input type="search" class="form-control" name="search-input" id="search-input" placeholder="Search..." aria-label="Search for..." autocomplete="off">
</div>
      </form>
      
    </div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>External pointer-based tokens objects</h1>
                        <h4 data-toc-skip class="author">Kohei Watanabe,
Stefan Müller, and Kenneth Benoit</h4>
            
      
      <small class="dont-index">Source: <a href="https://github.com/quanteda/quanteda/blob/HEAD/vignettes/pkgdown/tokens_xptr.Rmd" class="external-link"><code>vignettes/pkgdown/tokens_xptr.Rmd</code></a></small>
      <div class="hidden name"><code>tokens_xptr.Rmd</code></div>

    </div>

    
    
<div class="section level2">
<h2 id="introduction-to-tokens_xptr-in-quanteda-4">Introduction to <code>tokens_xptr</code> in
<strong>quanteda</strong> 4<a class="anchor" aria-label="anchor" href="#introduction-to-tokens_xptr-in-quanteda-4"></a>
</h2>
<p>In <strong>quanteda</strong> version 4.0, we introduced a new class
of tokens object, <code>tokens_xptr</code>. This object enhances the
efficiency of adjusting tokens objects based on large text corpora. A
sub-class of the <code>tokens</code> object, <code>tokens_xptr</code> is
built using on the external-pointer object <code>Rcpp::XPtr</code>.
External pointers allow <strong>quanteda</strong>’s tokens operations to
pass references to the object to be modified by the highly optimized C++
routines that perform these operations, without the overhead of passing
the objects by value back and forth from C++ to R code.</p>
<p>Prior to version 4, <strong>quanteda</strong>’s only version of a
<code>tokens</code> object has been an R list of integer vectors with
each integer mapped to a unique type. With each call of a
<code>tokens_*()</code> function, this object is converted to a C++
object, modified in C++, and then passed by value back to R and then
recreated into an R <code>tokens</code> object. Such conversion between
R and C++ consumes a large part of the execution time of each
<code>tokens_*()</code> function call, and this time consumption grows
as the size of the tokens object increases.</p>
<p>With the introduction of the <code>tokens_xptr</code> object, this
conversion upon passing the object for modification is fundamentally
changed, to passing just the reference to the tokens object so that it
can be modified by passing a reference (the external pointer) to the
object, eliminating the transaction costs of passing the classic
<code>tokens</code> object by value. The benefits of this are especially
visible when large tokens objects are processed, say those with more
than one million tokens, while still benefitting from the sequential
steps used in the typical <strong>quanteda</strong> tokens formatting
pipeline, such as creating the tokens, removing some based on a pattern,
lower-casing them, forming n-grams, etc. Formerly, with each step this
large object was passed by value. With <code>tokens_xptr</code>,
successive token processing steps only pass the external pointer,
resulting in significant efficiency gains without changing the clear
syntax and workflow used in a typical <strong>quanteda</strong> tokens
processing pipeline.</p>
<p>These efficiency gains are only evident for large tokens objects, for
instance those with more than one million tokens. The default
<code>tokens</code> object format remains the non-external pointer type,
but below, we show how to create and work with the
<code>tokens_xptr</code> variant. All of the <code>tokens_*()</code>
functions work the same for both object classes, so that the user-facing
differences are almost unnoticeable between the two object types.</p>
<p>A detailed comparison of performance gains and execution times for
<code>tokens</code> versus <code>tokens_xptr</code> objects is available
in a <a href="./articles/pkgdown/benchmarks_xptr.html">separate
article</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://quanteda.io">"quanteda"</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-tokens_xptr-objects">Creating `tokens_xptr`` objects<a class="anchor" aria-label="anchor" href="#creating-tokens_xptr-objects"></a>
</h2>
<p>There are two easy methods of creating a <code>tokens_xptr</code>
object.</p>
<p>First, you can create a <code>tokens_xptr</code> from
<code>tokens</code> using the <code><a href="../../reference/tokens_xptr.html">as.tokens_xptr()</a></code> method.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens.html">tokens</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">toks</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 59 documents and 4 docvars.</span></span>
<span><span class="va">xtoks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens_xptr.html">as.tokens_xptr</a></span><span class="op">(</span><span class="va">toks</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 59 documents and 4 docvars (pointer to 0x1409509b0).</span></span></code></pre></div>
<p>Second, this step can be performed by setting
<code>xptr = TRUE</code> argument in <code><a href="../../reference/tokens.html">tokens()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">xtoks2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens.html">tokens</a></span><span class="op">(</span><span class="va">data_corpus_inaugural</span>, xptr <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks2</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 59 documents and 4 docvars (pointer to 0x141015778).</span></span></code></pre></div>
<p>When <code>xtoks</code> object is printed, the address of its
underlying data is shown as <code>(pointer to xxxx)</code>. Because two
different objects were created above, the addresses displayed for
<code>xtoks</code> and <code>xtoks2</code> are different. We expand on
this below, in the discussion of shallow versus deep copies, when
binding new object names to existing <code>toks_xptr</code> objects.</p>
</div>
<div class="section level2">
<h2 id="modifying-xptr">Modifying <code>tokens_xptr</code> objects<a class="anchor" aria-label="anchor" href="#modifying-xptr"></a>
</h2>
<div class="section level3">
<h3 id="shallow-copies-versus-deep-copies">Shallow copies versus deep copies<a class="anchor" aria-label="anchor" href="#shallow-copies-versus-deep-copies"></a>
</h3>
<p>When we create a new object by assigning that to an existing
<code>tokens_xptr</code>, this creates what is known as a “shallow
copy”. A <em>shallow copy</em> is just a copy of the pointer to the
memory address where the <code>tokens_xptr</code> version of the tokens
objects exists. This contrasts with a “deep copy”, in which the new
object takes its data through a physical copy of the data from the old
memory location to a new one for the object. Assignment via a <em>deep
copy</em> is the how assignment of a a regular <code>tokens</code>
object — and indeed most R objects — works.</p>
<p>We can see this in operation here:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">toks</span> <span class="op">&lt;-</span> <span class="va">data_corpus_inaugural</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/corpus_reshape.html">corpus_reshape</a></span><span class="op">(</span>to <span class="op">=</span> <span class="st">"sentences"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/tokens.html">tokens</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="va">xtoks</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens_xptr.html">as.tokens_xptr</a></span><span class="op">(</span><span class="va">toks</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span>
<span></span>
<span><span class="co"># shallow copy</span></span>
<span><span class="va">xtoks_copy</span> <span class="op">&lt;-</span> <span class="va">xtoks</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks_copy</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span></code></pre></div>
<p>As an external pointer object, the underlying data of the copy of the
object <code>xtoks_copy</code> is the same. This means that operations
on <code>xtoks</code> using <code>tokens_*</code> functions also affect
<code>xtoks_copy</code> even after the copying (shallow copy).</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks</span>, max_ndoc <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span>
<span><span class="co">## 1789-Washington.1 :</span></span>
<span><span class="co">##  [1] "Fellow-Citizens" "of"              "the"             "Senate"         </span></span>
<span><span class="co">##  [5] "and"             "of"              "the"             "House"          </span></span>
<span><span class="co">##  [9] "of"              "Representatives" ":"               "Among"          </span></span>
<span><span class="co">## [ ... and 37 more ]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [ reached max_ndoc ... 5,233 more documents ]</span></span>
<span></span>
<span><span class="va">xtoks_copy</span> <span class="op">&lt;-</span> <span class="va">xtoks_copy</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html" class="external-link">stopwords</a></span><span class="op">(</span><span class="st">"en"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/tokens_tolower.html">tokens_tolower</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks</span>, max_ndoc <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span>
<span><span class="co">## 1789-Washington.1 :</span></span>
<span><span class="co">##  [1] "fellow-citizens" "senate"          "house"           "representatives"</span></span>
<span><span class="co">##  [5] ":"               "among"           "vicissitudes"    "incident"       </span></span>
<span><span class="co">##  [9] "life"            "event"           "filled"          "greater"        </span></span>
<span><span class="co">## [ ... and 11 more ]</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [ reached max_ndoc ... 5,233 more documents ]</span></span></code></pre></div>
<p>This is not the normal R behaviour for modifying objects, but does
exist in other packages that use external pointers, for instance,
<strong>data.table</strong>, which has an entire <a href="https://cran.r-project.org/web/packages/data.table/vignettes/datatable-reference-semantics.html" class="external-link">vignette
on reference semantics</a>.</p>
<p>If you want to copy the underlying data of a <code>tokens_xptr</code>
object (a <em>deep</em> copy), this can be done explicitly using
<code>copy()</code> or using <code><a href="../../reference/tokens_xptr.html">as.tokens_xptr()</a></code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># deep copies</span></span>
<span><span class="co"># print(copy(xtoks), 0, 0)</span></span>
<span><span class="co"># print(as.tokens_xptr(xtoks), 0, 0)</span></span></code></pre></div>
<p>Each of these has a different memory address from that of the
<code>xtoks</code> object above.</p>
</div>
<div class="section level3">
<h3 id="modifying-tokens_xptr-objects-using-tokens_-functions">Modifying <code>tokens_xptr</code> objects using
<code>tokens_*()</code> functions<a class="anchor" aria-label="anchor" href="#modifying-tokens_xptr-objects-using-tokens_-functions"></a>
</h3>
<p>The functions that modify <code>tokens_xptr</code> objects work in
exactly the same way as they do for <code>tokens</code> objects, with
the exception that they modify those objects by reference rather than
passing copies by value back and forth from R to the underlying C++ code
that performs the work.</p>
<p>Not all of the <code>tokens_()</code> functions are implemented this
way, because the efficiency gains for some would be negligible.
<code><a href="../../reference/tokens_select.html">tokens_select()</a></code>, <code><a href="../../reference/tokens_compound.html">tokens_compound()</a></code>,
<code><a href="../../reference/tokens_lookup.html">tokens_lookup()</a></code>, <code><a href="../../reference/tokens_ngrams.html">tokens_ngrams()</a></code> and
<code><a href="../../reference/tokens_replace.html">tokens_replace()</a></code> will return a shallow copy of the input
object for efficiency. However, <code><a href="../../reference/tokens_subset.html">tokens_subset()</a></code>,
<code>[]</code>, <code><a href="../../reference/tokens_group.html">tokens_group()</a></code>,
<code><a href="../../reference/tokens_segment.html">tokens_segment()</a></code> and <code><a href="../../reference/tokens_chunk.html">tokens_chunk()</a></code> return a
deep copy because they can change the number of the order of the
documents. If in any doubt, inspect the attention to the address of the
pointer <code>(pointer to xxxx)</code> when using
<code>tokens_xptr</code> objects.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span>
<span></span>
<span><span class="co"># shallow copy</span></span>
<span><span class="va">xtoks2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="va">xtoks</span>, <span class="fu"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html" class="external-link">stopwords</a></span><span class="op">(</span><span class="st">"en"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks2</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 5,234 documents and 4 docvars (pointer to 0x127df6d00).</span></span>
<span></span>
<span><span class="co"># deep copy</span></span>
<span><span class="va">xtoks3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/tokens_subset.html">tokens_subset</a></span><span class="op">(</span><span class="va">xtoks</span>, <span class="fu"><a href="https://rdrr.io/r/base/lengths.html" class="external-link">lengths</a></span><span class="op">(</span><span class="va">toks</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">150</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="va">xtoks3</span>, <span class="fl">0</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="co">## Tokens consisting of 11 documents and 4 docvars (pointer to 0x1404726d8).</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="saving-tokens_xptr-objects">Saving <code>tokens_xptr</code> objects<a class="anchor" aria-label="anchor" href="#saving-tokens_xptr-objects"></a>
</h2>
<p>Because they point to a memory location rather than containing the
data itself, a <code>tokens_xptr</code> object needs first needs to be
converted to a <code>tokens</code> object before its data can be saved
to disk. This is simple and performed by applying the
<code><a href="../../reference/as.tokens.html">as.tokens()</a></code> method to the <code>tokens_xptr</code> object.
After conversion, it can be saved normally using <code><a href="https://rdrr.io/r/base/save.html" class="external-link">save()</a></code> or
<code><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS()</a></code>.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># converting to tokens before saving</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/save.html" class="external-link">save</a></span><span class="op">(</span><span class="fu"><a href="../../reference/as.tokens.html">as.tokens</a></span><span class="op">(</span><span class="va">xtoks</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"~/tmp/xtoks.rda"</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">saveRDS</a></span><span class="op">(</span><span class="fu"><a href="../../reference/as.tokens.html">as.tokens</a></span><span class="op">(</span><span class="va">xtoks</span><span class="op">)</span>, file <span class="op">=</span> <span class="st">"~/tmp/xtoks.rds"</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-document-feature-matrix-from-a-tokens_xptr-object">Creating a document-feature matrix from a <code>tokens_xptr</code>
object<a class="anchor" aria-label="anchor" href="#creating-a-document-feature-matrix-from-a-tokens_xptr-object"></a>
</h2>
<p>Passing a <code>tokens_xptr</code> object directly to
<code><a href="../../reference/dfm.html">dfm()</a></code> to compile a document-feature matrix avoids a deep
copy of that object and for larger objects can significantly reduce
execution times for dfm creation.</p>
<p>We demonstrate this below, using several<code>tokens_*()</code>
functions to <code>tokens</code> and <code>tokens_xptr</code> objects to
construct a <code>dfm</code> in this mock pipeline. The execution time
for the latter is significantly shorter than for the former, thanks to
the cost saved by passing the data without the expensive conversion.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://ggplot2.tidyverse.org" class="external-link">"ggplot2"</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="st"><a href="https://github.com/joshuaulrich/microbenchmark/" class="external-link">"microbenchmark"</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">data_corpus_guardian</span> <span class="op">&lt;-</span> <span class="fu">quanteda.corpora</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/quanteda.corpora/man/download.html" class="external-link">download</a></span><span class="op">(</span><span class="st">"data_corpus_guardian"</span><span class="op">)</span></span>
<span><span class="va">toks</span> <span class="op">&lt;-</span> <span class="va">data_corpus_guardian</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/corpus_reshape.html">corpus_reshape</a></span><span class="op">(</span>to <span class="op">=</span> <span class="st">"sentences"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>    <span class="fu"><a href="../../reference/tokens.html">tokens</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">microbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/microbenchmark/man/microbenchmark.html" class="external-link">microbenchmark</a></span><span class="op">(</span></span>
<span>    tokens <span class="op">=</span> <span class="va">toks</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html" class="external-link">stopwords</a></span><span class="op">(</span><span class="st">"en"</span><span class="op">)</span>, padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"http:*"</span>, <span class="st">"https:*"</span>, <span class="st">"*.com"</span>, <span class="st">"*.org"</span>, <span class="st">"*.net"</span><span class="op">)</span>, padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_compound.html">tokens_compound</a></span><span class="op">(</span><span class="fu">newsmap</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/newsmap/man/data_dictionary_newsmap_en.html" class="external-link">data_dictionary_newsmap_en</a></span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/dfm.html">dfm</a></span><span class="op">(</span>remove_padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    tokens_xptr <span class="op">=</span> <span class="fu"><a href="../../reference/tokens_xptr.html">as.tokens_xptr</a></span><span class="op">(</span><span class="va">toks</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/stopwords/man/stopwords.html" class="external-link">stopwords</a></span><span class="op">(</span><span class="st">"en"</span><span class="op">)</span>, padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_select.html">tokens_remove</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"http:*"</span>, <span class="st">"https:*"</span>, <span class="st">"*.com"</span>, <span class="st">"*.org"</span>, <span class="st">"*.net"</span><span class="op">)</span>, padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/tokens_compound.html">tokens_compound</a></span><span class="op">(</span><span class="fu">newsmap</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/newsmap/man/data_dictionary_newsmap_en.html" class="external-link">data_dictionary_newsmap_en</a></span><span class="op">)</span> <span class="op">|&gt;</span> </span>
<span>        <span class="fu"><a href="../../reference/dfm.html">dfm</a></span><span class="op">(</span>remove_padding <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>    times <span class="op">=</span> <span class="fl">10</span></span>
<span><span class="op">)</span> <span class="op">|&gt;</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html" class="external-link">autoplot</a></span><span class="op">(</span>log <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span><span class="co">## Warning in microbenchmark::microbenchmark(tokens =</span></span>
<span><span class="co">## dfm(tokens_compound(tokens_remove(tokens_remove(toks, : less accurate</span></span>
<span><span class="co">## nanosecond times to avoid potential integer overflows</span></span></code></pre></div>
<p><img src="tokens_xptr_files/figure-html/unnamed-chunk-10-1.png" width="1200"></p>
<p>We explore further benchmarks and comparisons for
<code>tokens_xptr</code> usage in a <a href="./articles/pkgdown/benchmarks_xptr.html">separate article</a>.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Kenneth Benoit, Kohei Watanabe, Haiyan Wang, Paul Nulty, Adam Obeng, Stefan Müller, Akitaka Matsuo, William Lowe, European Research Council.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

      </footer>
</div>

  
<script src="https://cdnjs.cloudflare.com/ajax/libs/docsearch.js/2.6.1/docsearch.min.js" integrity="sha256-GKvGqXDznoRYHCwKXGnuchvKSwmx9SRMrZOTh2g4Sb0=" crossorigin="anonymous"></script><script>
  docsearch({
    
    
    apiKey: '9b4ef7fd791dc6075154d3ebd7b12acf',
    indexName: 'quanteda',
    inputSelector: 'input#search-input.form-control',
    transformData: function(hits) {
      return hits.map(function (hit) {
        hit.url = updateHitURL(hit);
        return hit;
      });
    }
  });
</script>
</body>
</html>
